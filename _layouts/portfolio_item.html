---
layout: default
---

{% assign portfolio_items = site.portfolio | sort: 'title' %}
{% assign current_index = 0 %}
{% for item in portfolio_items %}
  {% if item.url == page.url %}
    {% assign current_index = forloop.index0 %}
    {% break %}
  {% endif %}
{% endfor %}

{% assign prev_index = current_index | minus: 1 %}
{% assign next_index = current_index | plus: 1 %}

{% if prev_index < 0 %}
  {% assign prev_index = portfolio_items.size | minus: 1 %}
{% endif %}

{% if next_index >= portfolio_items.size %}
  {% assign next_index = 0 %}
{% endif %}

{% assign prev_item = portfolio_items[prev_index] %}
{% assign next_item = portfolio_items[next_index] %}

<div class="portfolio-item-page">
  <!-- Left Arrow -->
  <div class="portfolio-nav-arrow left-arrow">
    <a href="{{ prev_item.url }}" title="{{ prev_item.title }}">
      <span>&lt;</span>
    </a>
  </div>

  <div class="portfolio-content">
    <div class="portfolio-description">
      <h1>{{ page.title }}</h1>
      {{ content }}
    </div>

    <div class="portfolio-image">
      <img id="zoomable-image"
           src="{{ page.thumbnail }}"
           alt="{{ page.title }}"
           data-full-image="{{ page.full_image | default: page.thumbnail }}"
           {% if page.storymap_url %}data-storymap-url="{{ page.storymap_url }}"{% endif %}>
      
      <!-- Instructional text -->
      <div class="image-instruction">
        {% if page.storymap_url %}
          (Click to view story map)
        {% else %}
          (Click to view full-resolution image)
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Right Arrow -->
  <div class="portfolio-nav-arrow right-arrow">
    <a href="{{ next_item.url }}" title="{{ next_item.title }}">
      <span>&gt;</span>
    </a>
  </div>
</div>

<!-- Popup structure for zoom functionality -->
<div id="image-popup" class="popup">
  <span class="close-btn">&times;</span>
  <canvas id="popup-canvas"></canvas>
</div>

<style>
  .portfolio-item-page {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 40px;
    margin: 0 auto;
    position: relative;
  }

  .portfolio-content {
    display: flex;
    align-items: center;
    gap: 40px;
    flex: 1;
  }

  .portfolio-description {
    flex: 1;
  }

  .portfolio-image {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  .portfolio-image img {
    max-width: 100%;
    height: auto;
    object-fit: contain;
  }

  .image-instruction {
    color: white;
    font-size: 14px;
    margin-top: 10px;
    text-align: center;
  }

  .portfolio-nav-arrow {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 60px;
    height: 60px;
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    transition: background-color 0.3s ease;
  }

  .portfolio-nav-arrow:hover {
    background-color: rgba(255, 255, 255, 0.2);
  }

  .portfolio-nav-arrow a {
    color: white;
    font-size: 24px;
    font-weight: bold;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
  }

  .popup {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background-color: rgba(0,0,0,0.9);
  }
  #popup-canvas {
    display: block;
    margin: auto;
  }
  .close-btn {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
    z-index: 10000;
  }
  .close-btn:hover {
    color: #bbb;
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .portfolio-item-page {
      flex-direction: column;
      padding: 20px;
    }

    .portfolio-content {
      flex-direction: column;
      width: 100%;
    }

    .portfolio-nav-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 50px;
      height: 50px;
    }

    .left-arrow {
      left: 10px;
    }

    .right-arrow {
      right: 10px;
    }

    .portfolio-description {
      order: 2;
      width: 100%;
    }

    .portfolio-image {
      order: 1;
      width: 100%;
      margin-bottom: 20px;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const img = document.getElementById('zoomable-image');
  const popup = document.getElementById('image-popup');
  const canvas = document.getElementById('popup-canvas');
  const ctx = canvas.getContext('2d');
  const closeBtn = document.querySelector('.close-btn');
  
  // Check if this item has a storymap URL
  const storymapUrl = img.dataset.storymapUrl;

  // View transformation system for zoom/pan
  const view = (() => {
    const matrix = [1, 0, 0, 1, 0, 0];
    let m = matrix;
    let scale = 1;
    let ctx;
    const pos = { x: 0, y: 0 };
    let dirty = true;
    const API = {
      set context(_ctx) { ctx = _ctx; dirty = true },
      apply() {
        if (dirty) { this.update() }
        ctx.setTransform(m[0], m[1], m[2], m[3], m[4], m[5])
      },
      get scale() { return scale },
      get position() { return pos },
      isDirty() { return dirty },
      update() {
        dirty = false;
        m[3] = m[0] = scale;
        m[2] = m[1] = 0;
        m[4] = pos.x;
        m[5] = pos.y;
      },
      pan(amount) {
        if (dirty) { this.update() }
        pos.x += amount.x;
        pos.y += amount.y;
        dirty = true;
      },
      scaleAt(at, amount) {
        if (dirty) { this.update() }
        scale *= amount;
        pos.x = at.x - (at.x - pos.x) * amount;
        pos.y = at.y - (at.y - pos.y) * amount;
        dirty = true;
      },
      reset() {
        scale = 1;
        pos.x = 0;
        pos.y = 0;
        dirty = true;
      },
      fitToExtent(imgWidth, imgHeight, canvasWidth, canvasHeight) {
        const scaleX = canvasWidth / imgWidth;
        const scaleY = canvasHeight / imgHeight;
        scale = Math.min(scaleX, scaleY);
        pos.x = (canvasWidth - imgWidth * scale) / 2;
        pos.y = (canvasHeight - imgHeight * scale) / 2;
        dirty = true;
      }
    };
    return API;
  })();

  function fitImageToCanvas(fullSizeImg) {
    const canvasWidth = window.innerWidth;
    const canvasHeight = window.innerHeight;
    canvas.width = canvasWidth;
    canvas.height = canvasHeight;
    view.fitToExtent(fullSizeImg.naturalWidth, fullSizeImg.naturalHeight, canvasWidth, canvasHeight);
  }

  function drawCanvas(fullSizeImg) {
    if (view.isDirty()) {
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      view.apply();
      ctx.drawImage(fullSizeImg, 0, 0);
    }
    requestAnimationFrame(() => drawCanvas(fullSizeImg));
  }

  // Main click handler
  img.onclick = function() {
    // If this item has a storymap URL, open it instead of showing popup
    if (storymapUrl) {
      window.open(storymapUrl, '_blank', 'noopener,noreferrer');
      return;
    }

    // Otherwise, show the zoom popup
    popup.style.display = 'block';
    
    const fullSizeImg = new Image();
    fullSizeImg.onload = function() {
      view.context = ctx;
      fitImageToCanvas(fullSizeImg);
      drawCanvas(fullSizeImg);
    };
    fullSizeImg.src = img.dataset.fullImage;
  }

  // Close popup
  closeBtn.onclick = function() {
    popup.style.display = 'none';
  }

  // Close popup when clicking outside the image
  popup.onclick = function(e) {
    if (e.target === popup) {
      popup.style.display = 'none';
    }
  }

  // Mouse and wheel events for zoom/pan
  const mouse = {x: 0, y: 0, oldX: 0, oldY: 0, button: false};

  function mouseEvent(event) {
    if (event.type === "mousedown") { mouse.button = true }
    if (event.type === "mouseup" || event.type === "mouseout") { mouse.button = false }
    mouse.oldX = mouse.x;
    mouse.oldY = mouse.y;
    mouse.x = event.offsetX;
    mouse.y = event.offsetY
    if(mouse.button) {
      view.pan({x: mouse.x - mouse.oldX, y: mouse.y - mouse.oldY});
    }
  }

  function mouseWheelEvent(event) {
    const x = event.offsetX;
    const y = event.offsetY;
    if (event.deltaY < 0) {
      view.scaleAt({x, y}, 1.1);
    } else {
      view.scaleAt({x, y}, 1 / 1.1);
    }
    event.preventDefault();
  }

  canvas.addEventListener("mousemove", mouseEvent, {passive: true});
  canvas.addEventListener("mousedown", mouseEvent, {passive: true});
  canvas.addEventListener("mouseup", mouseEvent, {passive: true});
  canvas.addEventListener("mouseout", mouseEvent, {passive: true});
  canvas.addEventListener("wheel", mouseWheelEvent, {passive: false});

  // Handle window resize
  window.addEventListener('resize', function() {
    if (popup.style.display === 'block') {
      const fullSizeImg = new Image();
      fullSizeImg.onload = function() {
        fitImageToCanvas(fullSizeImg);
      };
      fullSizeImg.src = img.dataset.fullImage;
    }
  });
});
</script>
